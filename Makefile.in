#
#  Copyright (C) 2017-2019, Thomas Maier-Komor
#
#  This file belongs to Wire-Format-Compiler.
#
#  This program is free software: you can redistribute it and/or modify
#  it under the terms of the GNU General Public License as published by
#  the Free Software Foundation, either version 3 of the License, or
#  (at your option) any later version.
#
#  This program is distributed in the hope that it will be useful,
#  but WITHOUT ANY WARRANTY; without even the implied warranty of
#  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
#  GNU General Public License for more details.
#
#  You should have received a copy of the GNU General Public License
#  along with this program.  If not, see <http://www.gnu.org/licenses/>.
#

CC		= @CC@
CXX		= @CXX@
LEX		= @LEX@
YACC		= @YACC@
SED		= @SED@
HG		= @HG@
DIFF		= @DIFF@
RM		= @RM@
MV		= @MV@
MKDIR		= @MKDIR@
INSTALL		= @INSTALL@
PREFIX		= @prefix@

RELEASE		= @RELEASE@
BETA		= @BETA@

HGID		=$(shell if [ -d .hg ]; then hg id --id; else echo "none"; fi)
HGN		=$(shell if [ -d .hg ]; then hg id -n; else echo "none"; fi)
DVERSION	=$(shell date +%y%m)
BUILDY		=$(shell date +%y)
BUILDM		=$(shell date +%-m)
TAG		=$(shell if [ -d .hg ]; then hg log -r . -T {latesttag}; else echo "unknown"; fi)
TAGDELTA	=$(shell if [ -d .hg ]; then hg log -r . -T {changessincelatesttag}; else echo "0"; fi)
VERSION		=\"R$(DVERSION),ID:$(HGID)\"
RELVER		=$(TAG).$(TAGDELTA)
SHAREFILES	=$(shell hg st --all share | awk '/^[CAM]/{print $$2}')
INCFILES	=$(shell hg st --all include | awk '/^[CAM]/{print $$2}')
INCDIRS		=
DEFS		=-DRELEASE=$(RELEASE) $(BETA)
CFLAGS		= $(DEFS) $(INCDIRS)
CXXFLAGS	= $(DEFS) $(INCDIRS)
LIBS		= 

export CC CFLAGS CXX CXXFLAGS DEFS LDFLAGS LIBS OBJDIR DIFF RELEASE

default: release doc/wfc.pdf

dist:
	$(MAKE) distclean
	+$(MAKE) release
	+$(MAKE) mingw
	$(MAKE) -C src doc
	$(MAKE) tar


debug:DEFS	+=-DDEBUG -DYYDEBUG=1 
debug:CFLAGS	+= -g -Wall
debug:CXXFLAGS	+=-std=c++11 -g -Wall
debug:LIBS	+=-ldl -lpthread
debug:OBJDIR	=../obj-g
debug: bin
	+$(MAKE) -C src -e ../bin/wfc

release:CFLAGS	+=-O2
release:CXXFLAGS+=-std=c++11 -O2
release:LIBS	+=-ldl -lpthread
release:LDFLAGS	+=-Wl,-s
release:OBJDIR	=../obj-r
release: bin
	+$(MAKE) -C src -e ../bin/wfc

clang:CC	=clang
clang:CXX	=clang++
clang:CFLAGS	+=-O2
clang:CXXFLAGS	+=-std=c++11 -O2
clang:LIBS	+=-ldl -lpthread
clang:OBJDIR	=../obj-c
clang: bin
	+$(MAKE) -C src -e ../bin/wfc

tcov:CFLAGS	+= -fprofile-arcs -ftest-coverage
tcov:CXXFLAGS	+= -fprofile-arcs -ftest-coverage
tcov:LIBS	+=-ldl -lpthread
tcov:OBJDIR	=../obj-t
tcov: bin
	+$(MAKE) -C src -e ../bin/wfc

mingw:CC	=i686-w64-mingw32-gcc
mingw:CXX	=$(shell which i686-w64-mingw32-g++-posix || i686-w64-mingw32-g++)
mingw:CXXFLAGS	+=-g -O2 -fstack-protector-all
mingw:INCDIRS	=-I/opt/mingw/include/botan-2
mingw:LDFLAGS	=-static -static-libgcc -static-libstdc++ -Wl,-Bstatic,--nxcompat,--dynamicbase,--export-all-symbols,-s
mingw:LIBS	=-liphlpapi -lws2_32 #-lwsock32
mingw:OBJDIR	=../obj-m32
mingw: bin
	+$(MAKE) -C src -e ../bin/wfc.exe

mingw64:CC	=x86_64-w64-mingw32-gcc
mingw64:CXX	=$(shell which x86_64-w64-mingw32-g++-posix || x86_64-w64-mingw32-g++)
mingw64:CXXFLAGS+=-g -O2 -fno-keep-inline-dllexport -fstack-protector-all
mingw64:INCDIRS	=-I/opt/mingw64/include/botan-2
mingw64:LDFLAGS	=-static -static-libgcc -static-libstdc++ -Wl,-Bstatic,--nxcompat -Wl,--dynamicbase,--export-all-symbols,-s
mingw64:LIBS	=-liphlpapi -lws2_32 #-lwsock32
mingw64:OBJDIR	=../obj-m64
mingw64: bin
	+$(MAKE) -C src -e ../bin/wfc.exe

# job server will not be used by testsuite this way
# please start test-suite manually
test:
	cd testsuite; bash ./runtests.sh

bin:
	mkdir bin

clean:
	-rm -r obj-g obj-r obj-m obj-c obj-t src/.depend

distclean: clean
	-$(RM) bin/wfc bin/wfc.exe
	-$(MAKE) -C tests clean
	-$(RM) -R obj 

docs:
	$(MAKE) -C doc

doc/wfc.pdf:
	$(MAKE) -C doc

install:
	-$(MKDIR) -p $(PREFIX)/bin
	if [ -x bin/wfc ]; then $(INSTALL) bin/wfc $(PREFIX)/bin; elif [ -x bin/wfc.exe ]; then $(INSTALL) bin/wfc.exe $(PREFIX)/bin; else echo "build binary before installing"; exit 1; fi
	-$(MKDIR) -p $(PREFIX)/share
	$(INSTALL) share/* $(PREFIX)/share
	-$(MKDIR) -p $(PREFIX)/include
	$(INSTALL) include/* $(PREFIX)/include
	-$(MKDIR) -p $(PREFIX)/doc
	-$(INSTALL) doc/wfc.pdf $(PREFIX)/doc
